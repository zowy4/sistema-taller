name: Deploy to VPS

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        script: |
          # Create directory
          mkdir -p ~/taller-app
          
          # Clone/pull latest code
          if [ -d ~/taller-app/.git ]; then
            cd ~/taller-app
            git pull origin master
          else
            rm -rf ~/taller-app
            git clone https://github.com/${{ github.repository }}.git ~/taller-app
            cd ~/taller-app
          fi
          
          # Create backend .env
          cat > backend/.env <<'BACKENDENV'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PORT=3002
          NODE_ENV=production
          BACKENDENV
          
          # Create frontend .env.production
          cat > frontend/.env.production <<'FRONTENDENV'
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          FRONTENDENV
          
          # Stop existing containers
          docker-compose down || true
          
          # Build and start containers
          docker-compose up -d --build
          
          # Wait for services to start
          echo "Waiting for services to start..."
          sleep 15
          
          # Run migrations
          docker-compose exec -T backend npx prisma migrate deploy || echo "Migrations failed or not needed"
          
          # Check container status
          docker-compose ps
          
          # Show recent logs
          docker-compose logs --tail=50

    - name: Health Check
      run: |
        echo "Performing health check..."
        sleep 10
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}:3002 || echo "000")
        if [ "$response" = "200" ] || [ "$response" = "404" ]; then
          echo "âœ… Backend is responding (HTTP $response)"
        else
          echo "âš ï¸ Backend returned HTTP $response (may still be starting)"
        fi

    - name: Deployment Summary
      if: always()
      run: |
        echo "## Deployment Results ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VPS**: ${{ secrets.VPS_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ secrets.VPS_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Services Status" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Backend deployed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Frontend deployed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Database migrations applied" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    environment: production

    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        script: |
          echo "Deployment failed. Attempting restart..."
          cd ~/taller-app
          docker-compose restart || docker-compose up -d

    - name: Notify rollback
      run: |
        echo "## âš ï¸ Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Deployment failed. Containers were restarted." >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs and fix issues before retrying." >> $GITHUB_STEP_SUMMARY
