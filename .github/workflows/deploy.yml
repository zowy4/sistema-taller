name: Deploy to VPS

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy files to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        source: "."
        target: "~/taller-app"
        rm: false
        strip_components: 0
        overwrite: true

    - name: Create environment files
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        script: |
          cd ~/taller-app
          
          # Create backend .env
          cat > backend/.env <<'BACKENDENV'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PORT=3002
          NODE_ENV=production
          BACKENDENV
          
          # Create frontend .env.production
          cat > frontend/.env.production <<'FRONTENDENV'
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          FRONTENDENV
          
          echo "âœ… Environment files created"

    - name: Install Docker (if needed)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        timeout: 5m
        script: |
          if ! command -v docker &> /dev/null; then
            echo "ðŸ“¦ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
          fi
          
          if ! command -v docker-compose &> /dev/null; then
            echo "ðŸ“¦ Installing Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          echo "âœ… Docker ready"
          docker --version
          docker-compose --version

    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        timeout: 20m
        command_timeout: 20m
        script: |
          cd ~/taller-app
          
          echo "ðŸ§¹ Cleaning Next.js cache..."
          rm -rf frontend/.next
          
          echo "ðŸ”„ Rebuilding and restarting containers..."
          docker-compose up -d --build --force-recreate --no-cache
          
          echo "â³ Waiting for services to start..."
          sleep 30
          
          echo "ï¿½ Container status:"
          docker-compose ps
          
          # Verify containers are running
          if [ $(docker-compose ps -q | wc -l) -eq 0 ]; then
            echo "âš ï¸ No containers running, attempting restart..."
            docker-compose up -d
            sleep 20
            docker-compose ps
          fi
          
          echo "ðŸ“¦ Running database migrations..."
          docker-compose exec -T backend npx prisma migrate deploy 2>/dev/null || echo "âš ï¸ Migrations skipped"
          
          echo "ðŸ“ Recent logs:"
          docker-compose logs --tail=50
          
          # Final verification
          echo "âœ… Deployment completed"
          docker ps --filter name=taller

    - name: Health Check
      run: |
        echo "Performing health check..."
        sleep 10
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}:3002 || echo "000")
        if [ "$response" = "200" ] || [ "$response" = "404" ]; then
          echo "âœ… Backend is responding (HTTP $response)"
        else
          echo "âš ï¸ Backend returned HTTP $response (may still be starting)"
        fi

    - name: Deployment Summary
      if: always()
      run: |
        echo "## Deployment Results ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VPS**: ${{ secrets.VPS_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ secrets.VPS_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Services Status" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Backend deployed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Frontend deployed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Database migrations applied" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    environment: production

    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        script: |
          echo "Deployment failed. Attempting restart..."
          cd ~/taller-app
          docker-compose restart || docker-compose up -d

    - name: Notify rollback
      run: |
        echo "## âš ï¸ Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Deployment failed. Containers were restarted." >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs and fix issues before retrying." >> $GITHUB_STEP_SUMMARY
