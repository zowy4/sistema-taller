generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Clientes {
  id_cliente      Int                @id @default(autoincrement())
  nombre          String
  apellido        String
  empresa         String?
  telefono        String
  email           String             @unique
  password        String?
  direccion       String
  fecha_alta      DateTime           @default(now())
  ordenes_trabajo OrdenesDeTrabajo[]
  vehiculos       Vehiculos[]
}

model Vehiculos {
  id_vehiculo     Int                  @id @default(autoincrement())
  placa           String               @unique
  vin             String               @unique
  marca           String
  modelo          String
  anio            Int
  detalles        String?
  id_cliente      Int
  historial       Historial_Vehiculo[]
  ordenes_trabajo OrdenesDeTrabajo[]
  cliente         Clientes             @relation(fields: [id_cliente], references: [id_cliente])
}

model Empleados {
  id_empleado         Int                @id @default(autoincrement())
  nombre              String
  apellido            String
  email               String?            @unique
  password            String?
  rol                 String
  fecha_ingreso       DateTime           @default(now())
  activo              Boolean            @default(true)
  direccion           String?
  telefono            String?
  permisos            Empleado_Permiso[]
  ordenes_responsable OrdenesDeTrabajo[]
}

model OrdenesDeTrabajo {
  id_orden                Int                  @id @default(autoincrement())
  fecha_apertura          DateTime             @default(now())
  fecha_entrega_estimada  DateTime?
  fecha_entrega_real      DateTime?
  estado                  String
  total_estimado          Float
  total_real              Float?
  id_cliente              Int
  id_vehiculo             Int
  id_empleado_responsable Int?
  notas                   String?
  factura                 Facturas?
  historial               Historial_Vehiculo[]
  cliente                 Clientes             @relation(fields: [id_cliente], references: [id_cliente])
  empleado_responsable    Empleados?           @relation(fields: [id_empleado_responsable], references: [id_empleado], onDelete: Restrict)
  vehiculo                Vehiculos            @relation(fields: [id_vehiculo], references: [id_vehiculo])
  repuestos_usados        Ordenes_Repuestos[]
  servicios_asignados     Ordenes_Servicios[]
}

model Repuestos {
  id_repuesto       Int                 @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  unidad_medida     String
  stock_actual      Int
  precio_venta      Float
  stock_minimo      Int
  codigo            String              @unique
  precio_compra     Float
  compras_repuestos Compras_Repuestos[]
  ordenes_donde_usa Ordenes_Repuestos[]
}

model Servicios {
  id_servicio          Int                 @id @default(autoincrement())
  nombre               String              @unique
  descripcion          String?
  precio               Float
  activo               Boolean             @default(true)
  tiempo_estimado      Int?
  ordenes_donde_aplica Ordenes_Servicios[]
}

model Ordenes_Servicios {
  id              Int              @id @default(autoincrement())
  cantidad        Int
  precio_unitario Float
  subtotal        Float
  id_orden        Int
  id_servicio     Int
  orden           OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])
  servicio        Servicios        @relation(fields: [id_servicio], references: [id_servicio])

  @@unique([id_orden, id_servicio])
}

model Ordenes_Repuestos {
  id              Int              @id @default(autoincrement())
  cantidad        Int
  precio_unitario Float
  subtotal        Float
  id_orden        Int
  id_repuesto     Int
  orden           OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])
  repuesto        Repuestos        @relation(fields: [id_repuesto], references: [id_repuesto])

  @@unique([id_orden, id_repuesto])
}

model Facturas {
  id_factura    Int              @id @default(autoincrement())
  fecha_factura DateTime         @default(now())
  monto         Float
  estado_pago   String
  metodo_pago   String?
  id_orden      Int              @unique
  orden         OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])
}

model Historial_Vehiculo {
  id_hist     Int              @id @default(autoincrement())
  fecha       DateTime
  kilometraje Int
  notas       String?
  id_vehiculo Int
  id_orden    Int
  orden       OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])
  vehiculo    Vehiculos        @relation(fields: [id_vehiculo], references: [id_vehiculo])
}

model Roles {
  id_rol      Int           @id @default(autoincrement())
  nombre      String        @unique
  descripcion String?
  activo      Boolean       @default(true)
  permisos    Rol_Permiso[]
}

model Permisos {
  id_permiso  Int                @id @default(autoincrement())
  nombre      String             @unique
  descripcion String?
  modulo      String
  accion      String
  empleados   Empleado_Permiso[]
  roles       Rol_Permiso[]
}

model Rol_Permiso {
  id_rol     Int
  id_permiso Int
  permiso    Permisos @relation(fields: [id_permiso], references: [id_permiso])
  rol        Roles    @relation(fields: [id_rol], references: [id_rol])

  @@id([id_rol, id_permiso])
}

model Empleado_Permiso {
  id_empleado Int
  id_permiso  Int
  empleado    Empleados @relation(fields: [id_empleado], references: [id_empleado])
  permiso     Permisos  @relation(fields: [id_permiso], references: [id_permiso])

  @@id([id_empleado, id_permiso])
}

model Proveedores {
  id_proveedor Int       @id @default(autoincrement())
  nombre       String
  empresa      String?
  telefono     String
  email        String    @unique
  direccion    String?
  activo       Boolean   @default(true)
  fecha_alta   DateTime  @default(now())
  compras      Compras[]
}

model Compras {
  id_compra         Int                 @id @default(autoincrement())
  fecha_compra      DateTime            @default(now())
  total             Float
  estado            String              @default("completada")
  notas             String?
  id_proveedor      Int
  proveedor         Proveedores         @relation(fields: [id_proveedor], references: [id_proveedor])
  compras_repuestos Compras_Repuestos[]
}

model Compras_Repuestos {
  id              Int       @id @default(autoincrement())
  cantidad        Int
  precio_unitario Float
  subtotal        Float
  id_compra       Int
  id_repuesto     Int
  compra          Compras   @relation(fields: [id_compra], references: [id_compra])
  repuesto        Repuestos @relation(fields: [id_repuesto], references: [id_repuesto])

  @@unique([id_compra, id_repuesto])
}
