datasource db {
  
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Clientes {
  id_cliente  Int      @id @default(autoincrement())
  nombre      String
  apellido    String
  empresa     String?
  telefono    String
  email       String   @unique
  password    String?
  direccion   String
  fecha_alta  DateTime @default(now())

  vehiculos   Vehiculos[]
  ordenes_trabajo OrdenesDeTrabajo[]
}

model Vehiculos {
  id_vehiculo Int      @id @default(autoincrement())
  placa       String   @unique
  vin         String   @unique
  marca       String
  modelo      String
  anio        Int
  detalles    String?

  id_cliente  Int
  cliente     Clientes @relation(fields: [id_cliente], references: [id_cliente])

  ordenes_trabajo OrdenesDeTrabajo[]
  historial Historial_Vehiculo[]
}

model Empleados {
  id_empleado   Int      @id @default(autoincrement())
  nombre        String
  apellido      String
  email         String?  @unique
  password      String?
  telefono      String?
  direccion     String?
  rol           String
  fecha_ingreso DateTime @default(now())
  activo        Boolean  @default(true)

  ordenes_responsable OrdenesDeTrabajo[]
  permisos      Empleado_Permiso[]
}

model OrdenesDeTrabajo {
  id_orden                Int      @id @default(autoincrement())
  fecha_apertura          DateTime @default(now())
  fecha_entrega_estimada  DateTime
  fecha_entrega_real      DateTime?
  estado                  String
  total_estimado          Float
  total_real              Float?
  
  id_cliente  Int
  cliente     Clientes @relation(fields: [id_cliente], references: [id_cliente])

  id_vehiculo Int
  vehiculo    Vehiculos @relation(fields: [id_vehiculo], references: [id_vehiculo])

  id_empleado_responsable Int
  empleado_responsable  Empleados @relation(fields: [id_empleado_responsable], references: [id_empleado])

  servicios_asignados Ordenes_Servicios[]
  repuestos_usados    Ordenes_Repuestos[]
  factura     Facturas?
  historial   Historial_Vehiculo[]
}

model Repuestos {
  id_repuesto         Int      @id @default(autoincrement())
  nombre              String   @unique
  descripcion         String?
  unidad_medida       String
  cantidad_existente  Int
  precio_unitario     Float
  nivel_minimo_alerta Int

  ordenes_donde_usa   Ordenes_Repuestos[]
}

model Servicios {
  id_servicio     Int      @id @default(autoincrement())
  nombre          String   @unique
  descripcion     String?
  precio_estandar Float
  activo          Boolean  @default(true)

  ordenes_donde_aplica Ordenes_Servicios[]
}

model Ordenes_Servicios {
  id          Int   @id @default(autoincrement())
  cantidad    Int
  precio_unitario Float
  subtotal    Float

  id_orden    Int
  orden       OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])

  id_servicio Int
  servicio    Servicios @relation(fields: [id_servicio], references: [id_servicio])
  
  @@unique([id_orden, id_servicio])
}

model Ordenes_Repuestos {
  id          Int   @id @default(autoincrement())
  cantidad    Int
  precio_unitario Float
  subtotal    Float

  id_orden    Int
  orden       OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])

  id_repuesto Int
  repuesto    Repuestos @relation(fields: [id_repuesto], references: [id_repuesto])

  @@unique([id_orden, id_repuesto])
}

model Facturas {
  id_factura   Int      @id @default(autoincrement())
  fecha_factura DateTime @default(now())
  monto         Float
  estado_pago   String
  metodo_pago   String?

  id_orden    Int      @unique
  orden       OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])
}

model Historial_Vehiculo {
  id_hist     Int      @id @default(autoincrement())
  fecha       DateTime
  kilometraje Int
  notas       String?

  id_vehiculo Int
  vehiculo    Vehiculos @relation(fields: [id_vehiculo], references: [id_vehiculo])

  id_orden    Int
  orden       OrdenesDeTrabajo @relation(fields: [id_orden], references: [id_orden])
}

model Roles {
  id_rol      Int      @id @default(autoincrement())
  nombre      String   @unique
  descripcion String?
  activo      Boolean  @default(true)
  
  permisos    Rol_Permiso[]
}

model Permisos {
  id_permiso  Int      @id @default(autoincrement())
  nombre      String   @unique
  descripcion String?
  modulo      String
  accion      String
  
  roles       Rol_Permiso[]
  empleados   Empleado_Permiso[]
}

model Rol_Permiso {
  id_rol      Int
  rol         Roles @relation(fields: [id_rol], references: [id_rol])
  
  id_permiso  Int
  permiso     Permisos @relation(fields: [id_permiso], references: [id_permiso])
  
  @@id([id_rol, id_permiso])
}

model Empleado_Permiso {
  id_empleado Int
  empleado    Empleados @relation(fields: [id_empleado], references: [id_empleado])
  
  id_permiso  Int
  permiso     Permisos @relation(fields: [id_permiso], references: [id_permiso])
  
  @@id([id_empleado, id_permiso])
}